#!/usr/bin/with-contenv bash
# shellcheck shell=bash

mkdir -p /run/readsb

# Build the readsb command line based on options
READSB_BIN="/usr/local/bin/readsb"

READSB_CMD=(--net-only)
READSB_CMD+=(--quiet)

if [ -n "${LAT}" ]; then
    READSB_CMD+=(--lat "${LAT}")
fi

if [ -n "${LONG}" ]; then
    READSB_CMD+=(--lon "${LONG}")
fi

if [ -n "${MLATHOST}" ]; then
    READSB_CMD+=("--net-connector=${MLATHOST},${MLATPORT},beast_in")
fi

if [ -n "${BEASTHOST}" ]; then
    READSB_CMD+=("--net-connector=${BEASTHOST},${BEASTPORT},beast_in")
fi

READSB_CMD+=(--write-json=/run/readsb)
READSB_CMD+=(--heatmap-dir /var/globe_history)
READSB_CMD+=(--heatmap 15)
READSB_CMD+=(--write-state=/var/globe_history)
READSB_CMD+=(--write-state-only-on-exit)
READSB_CMD+=(--json-trace-interval 14)
READSB_CMD+=(--json-reliable 1)
READSB_CMD+=("--max-range=$READSB_MAX_RANGE")

READSB_CMD+=(--net-ro-port=30002)
READSB_CMD+=(--net-sbs-port=30003)
READSB_CMD+=("--net-bi-port=30004,30104")
READSB_CMD+=(--net-bo-port=30005)
READSB_CMD+=(--net-json-port=30047)
READSB_CMD+=(--forward-mlat)

if [ -n "${READSB_DEBUG}" ]; then
    READSB_CMD+=("--debug=$READSB_DEBUG")
fi

# make sure the db file exists, and if it does, use it
if [[ -e $TAR1090_INSTALL_DIR/aircraft.csv.gz ]]; then
    if [[ "$TAR1090_ENABLE_AC_DB" == "true" ]]; then
        READSB_CMD+=("--db-file=$TAR1090_INSTALL_DIR/aircraft.csv.gz")
    fi
fi

# shellcheck disable=SC2086
"${READSB_BIN}" "${READSB_CMD[@]}" $READSB_EXTRA_ARGS 2>&1 | awk -W Interactive '{print "[readsb] " $0}'
